<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
	<title>سوبر جاسم - نسخة مستقلة</title>
	<style>
		* { box-sizing: border-box; margin: 0; padding: 0 }
		body {
			background: linear-gradient(135deg, #87CEEB 0%, #98FB98 100%);
			font-family: "Segoe UI", Tahoma, Arial, sans-serif;
			color: #fff;
			display: flex;
			flex-direction: column;
			align-items: center;
			min-height: 100vh;
			user-select: none;
			-webkit-tap-highlight-color: transparent;
			overflow-x: hidden;
		}
		h1 {
			margin: 14px 0 6px;
			text-shadow: 3px 3px 0 #000;
			font-weight: 900;
			font-size: 2.3em;
			background: linear-gradient(45deg, #FFD700, #FFA500);
			-webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
		}
		.sub { opacity: .95; margin-bottom: 8px; font-size: 1.05em; text-shadow: 2px 2px 0 #000 }
		.sharebar { margin: 8px 0 0; display:flex; gap: 10px }
		.sharebtn { border:none; background: linear-gradient(135deg,#FFD700,#FFA500); color:#8B4513; font-weight:800; padding:10px 16px; border-radius:12px; box-shadow:0 4px 0 rgba(0,0,0,.3); cursor:pointer; font-size:14px }
		.sharebtn:active { transform: translateY(2px); box-shadow:0 2px 0 rgba(0,0,0,.3) }
		.game-wrap { position: relative; width: 96vw; max-width: 1100px; aspect-ratio: 16/9; border: 6px solid #8B4513; border-radius: 18px; overflow:hidden; background:#63adff; box-shadow:0 20px 40px rgba(0,0,0,.4); margin: 14px 0 }
		canvas { width:100%; height:100%; display:block; image-rendering: pixelated; background: linear-gradient(#76b8ff, #8cd1ff 55%, #63adff) }
		.hud { position:absolute; inset: 10px 10px auto 10px; display:flex; justify-content:space-between; gap:10px; pointer-events:none; font-weight:800; text-shadow:2px 2px 0 #000; z-index:10 }
		.hud .left, .hud .right { display:flex; gap: 12px }
		.badge { background: rgba(0,0,0,.5); padding:8px 12px; border-radius:12px; border:2px solid rgba(255,255,255,.25); font-size:14px }
		.msg { position:absolute; inset:0; display:none; align-items:center; justify-content:center; flex-direction:column; gap:14px; background:rgba(0,0,0,.6); text-align:center; font-size:32px; font-weight:900; text-shadow:3px 3px 0 #000; padding:24px; z-index:20 }
		.msg small { font-size:18px; opacity:.9 }
		.mobile-controls { position: fixed; left:0; right:0; bottom: 16px; display:flex; justify-content:space-between; align-items:center; padding:0 18px; z-index:100; gap: 12px }
		.control-group { display:flex; gap: 12px; align-items:center }
		.btn { width:64px; height:64px; border:none; border-radius:50%; font-size:22px; font-weight:800; box-shadow:0 6px 0 rgba(0,0,0,.3); cursor:pointer; transition: all .2s ease; user-select:none; touch-action: manipulation }
		.btn:active { transform: translateY(3px); box-shadow:0 3px 0 rgba(0,0,0,.3) }
		.btn.left { background: linear-gradient(135deg,#4CAF50,#2E7D32); color:#fff }
		.btn.right { background: linear-gradient(135deg,#2196F3,#0D47A1); color:#fff }
		.btn.up { background: linear-gradient(135deg,#00BCD4,#006064); color:#fff }
		.btn.down { background: linear-gradient(135deg,#9C27B0,#4A148C); color:#fff }
		.btn.jump { background: linear-gradient(135deg,#FF5722,#BF360C); color:#fff }
		.btn.fire { background: linear-gradient(135deg,#FF9800,#E65100); color:#fff }
		.btn.special { background: linear-gradient(135deg,#FFC107,#FFA000); color:#000; width:56px; height:56px; font-size:18px }
		@media(min-width:900px){ .mobile-controls{ display:none } }
		.overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.7); z-index: 1000; padding: 18px }
		.card { background: #fff; color:#222; max-width:95vw; border-radius:16px; padding:20px; box-shadow:0 20px 40px rgba(0,0,0,.4); border:3px solid #ddd }
		.card h3 { margin-bottom:10px; color:#8B4513; font-size:22px }
		.row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px }
		.urlbox { width:360px; max-width:80vw; padding:10px 12px; border:2px solid #ccc; border-radius:10px; font-size:14px }
		.qr { width:240px; height:240px; border:3px solid #ddd; border-radius:12px }
		.close { background: linear-gradient(135deg,#666,#555); color:#fff; border:2px solid #444 }
		.perf { position: fixed; top: 12px; right: 12px; background: rgba(0,0,0,.6); color:#fff; padding:10px 12px; border-radius:12px; font-family: monospace; font-size:12px; border:1px solid rgba(255,255,255,.25); z-index:50 }
	</style>
</head>
<body>
	<h1>🍄 سوبر جاسم 🍄</h1>
	<div class="sub">نسخة مستقلة في ملف واحد - أزرار لمس للهاتف - زر الرصاص Ctrl</div>
	<div class="sharebar">
		<button id="openShare" class="sharebtn">🔗 مشاركة / QR</button>
		<button id="fullscreen" class="sharebtn">⛶ ملء الشاشة</button>
		<button id="copyCode" class="sharebtn">📋 نسخ الكود الكامل</button>
		<button id="copyCmds" class="sharebtn">📋 نسخ أوامر التشغيل</button>
		<button id="openServerUrl" class="sharebtn">▶ فتح رابط التشغيل</button>
		<button id="openCode" class="sharebtn">🗎 فتح الكود</button>
		<button id="downloadCode" class="sharebtn">⬇ تنزيل الملف</button>
	</div>
	<div class="game-wrap">
		<canvas id="game"></canvas>
		<div class="hud">
			<div class="left">
				<div class="badge">النقاط: <span id="uiScore">0</span></div>
				<div class="badge">الأرواح: <span id="uiLives">3</span></div>
				<div class="badge">العملات: <span id="uiCoins">0</span></div>
			</div>
			<div class="right">
				<div class="badge">المستوى: <span id="uiLevel">1</span></div>
				<div class="badge">الوقت: <span id="uiTime">300</span></div>
			</div>
		</div>
		<div id="msg" class="msg"></div>
	</div>
	<div class="mobile-controls">
		<div class="control-group">
			<button class="btn left" id="btnLeft">◀</button>
			<button class="btn down" id="btnDown">▼</button>
			<button class="btn right" id="btnRight">▶</button>
		</div>
		<div class="control-group">
			<button class="btn up" id="btnUp">▲</button>
			<button class="btn jump" id="btnJump">⤒</button>
			<button class="btn fire" id="btnFire">✶</button>
		</div>
		<div class="control-group">
			<button class="btn special" id="btnPause">⏸</button>
			<button class="btn special" id="btnMenu">☰</button>
		</div>
	</div>
	<div id="overlay" class="overlay">
		<div class="card">
			<h3>مشاركة اللعبة</h3>
			<div class="row">
				<input id="shareUrl" class="urlbox" readonly />
				<button id="copyShare" class="sharebtn">نسخ الرابط</button>
				<button id="nativeShare" class="sharebtn">مشاركة</button>
			</div>
			<div class="row">
				<img id="qr" class="qr" alt="QR" />
				<div style="max-width:350px; font-size:14px; line-height:1.6">
					<strong>ملاحظات:</strong><br>
					• يعمل QR عند فتح الملف عبر خادم محلي (الرابط يبدأ بـ http)<br>
					• لفتح خادم سريع: python3 -m http.server 8000 ثم افتح الرابط بالأسفل
				</div>
			</div>
			<button id="closeOverlay" class="sharebtn close">إغلاق</button>
		</div>
	</div>
	<div class="perf" id="perf">FPS: 60 | Objects: 0</div>
	<script>
	(function(){
		const canvas = document.getElementById('game');
		const ctx = canvas.getContext('2d');
		let W = 960, H = 540; // 16:9
		function resize(){
			// ثابت داخلي للرسم، المقياس عبر CSS
			canvas.width = W; canvas.height = H; ctx.imageSmoothingEnabled = false;
		}
		resize();

		// حالة اللعبة
		const state = {
			score: 0, lives: 3, coins: 0, level: 1, time: 300,
			game: 'menu', // menu|playing|paused|over
			keys: Object.create(null), touch: {left:false,right:false,up:false,down:false,jump:false,fire:false},
			lastShot: 0, fps: 60, _lfps: performance.now(), frames:0
		};

		// اللاعب
		const player = { x: 120, y: 380, w: 28, h: 32, vx: 0, vy: 0, on: false, face: 1, health: 100 };
		// منصات بسيطة
		const platforms = [
			{ x: 0, y: 500, w: 2000, h: 40, type: 'ground' },
			{ x: 260, y: 440, w: 120, h: 16, type: 'grass' },
			{ x: 480, y: 400, w: 120, h: 16, type: 'grass' },
			{ x: 720, y: 360, w: 120, h: 16, type: 'grass' }
		];
		// أعداء مختصرون
		const enemies = [
			{ x: 620, y: 468, w: 28, h: 28, vx: -1, vy: 0, on:false, type:'goomba', alive:true, base:620 }
		];
		// رصاص
		const bullets = [];
		// عملات
		const coins = [ {x:300,y:410,w:18,h:18,a:true,r:0}, {x:520,y:370,w:18,h:18,a:true,r:0}, {x:760,y:330,w:18,h:18,a:true,r:0} ];

		// كاميرا بسيطة
		const cam = { x: 0, y: 0, w: W, h: H };

		// عناصر UI
		const ui = {
			score: document.getElementById('uiScore'),
			lives: document.getElementById('uiLives'),
			coins: document.getElementById('uiCoins'),
			level: document.getElementById('uiLevel'),
			time: document.getElementById('uiTime'),
			msg: document.getElementById('msg'),
			perf: document.getElementById('perf')
		};

		// إدخال لوحة المفاتيح (Ctrl لإطلاق الرصاص)
		document.addEventListener('keydown', e=>{
			state.keys[e.code] = true;
			if(["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.code)) e.preventDefault();
			if(state.game==='menu' && e.code==='Enter') start();
			if(e.code==='KeyP') togglePause();
		});
		document.addEventListener('keyup', e=> state.keys[e.code]=false);

		// لمس الهاتف
		function bindHold(id, prop){
			const el = document.getElementById(id);
			if(!el) return;
			const on = ()=> state.touch[prop]=true;
			const off = ()=> state.touch[prop]=false;
			['touchstart','mousedown'].forEach(ev=> el.addEventListener(ev, on));
			['touchend','mouseup','mouseleave','touchcancel'].forEach(ev=> el.addEventListener(ev, off));
		}
		bindHold('btnLeft','left'); bindHold('btnRight','right'); bindHold('btnUp','up'); bindHold('btnDown','down'); bindHold('btnJump','jump'); bindHold('btnFire','fire');
		const btnPause = document.getElementById('btnPause'); if(btnPause){ btnPause.addEventListener('click', togglePause); }
		const btnMenu = document.getElementById('btnMenu'); if(btnMenu){ btnMenu.addEventListener('click', ()=> showMsg('القائمة','اضغط Enter للبدء')); }

		// مشاركة
		const openShare = document.getElementById('openShare');
		const overlay = document.getElementById('overlay');
		const shareUrl = document.getElementById('shareUrl');
		const qr = document.getElementById('qr');
		const copyShare = document.getElementById('copyShare');
		const nativeShare = document.getElementById('nativeShare');
		const closeOverlay = document.getElementById('closeOverlay');
		const copyCodeBtn = document.getElementById('copyCode');
		const copyCmdsBtn = document.getElementById('copyCmds');
		const openServerBtn = document.getElementById('openServerUrl');
		const openCodeBtn = document.getElementById('openCode');
		const downloadCodeBtn = document.getElementById('downloadCode');
		if(openShare){ openShare.addEventListener('click', ()=>{
			const url = location.href;
			shareUrl.value = url;
			qr.src = 'https://api.qrserver.com/v1/create-qr-code/?size=240x240&data='+encodeURIComponent(url);
			overlay.style.display='flex';
		});}
		if(copyShare){ copyShare.addEventListener('click', ()=>{ shareUrl.select(); document.execCommand('copy'); copyShare.textContent='تم النسخ!'; setTimeout(()=>copyShare.textContent='نسخ الرابط',1500); }); }
		if(nativeShare){ nativeShare.addEventListener('click', ()=>{ if(navigator.share){ navigator.share({title:'سوبر جاسم', text:'جرّب لعبة سوبر جاسم!', url:location.href}); } else alert('المشاركة الأصلية غير مدعومة'); }); }
		if(closeOverlay){ closeOverlay.addEventListener('click', ()=> overlay.style.display='none'); }
		const fsBtn = document.getElementById('fullscreen'); if(fsBtn){ fsBtn.addEventListener('click', ()=>{ if(!document.fullscreenElement){ document.documentElement.requestFullscreen().catch(()=>{});} else { document.exitFullscreen(); } }); }

		// نسخ نص إلى الحافظة مع بديل
		async function copyText(text){
			// المحاولة 1: Clipboard API (يتطلب HTTPS أو localhost وبعض المتصفحات)
			try { if(navigator.clipboard && window.isSecureContext !== false){ await navigator.clipboard.writeText(text); return true; } } catch(_){ }
			// المحاولة 2: عنصر textarea مخفي + تحديد يدوي (يعمل في معظم المتصفحات)
			try{
				const ta = document.createElement('textarea');
				ta.style.position='fixed'; ta.style.left='-10000px'; ta.style.top='-10000px'; ta.value=text;
				document.body.appendChild(ta);
				ta.focus(); ta.select(); ta.setSelectionRange(0, ta.value.length);
				const ok = document.execCommand('copy');
				document.body.removeChild(ta);
				return ok;
			}catch(_){ }
			return false;
		}

		// زر: نسخ الكود الكامل (الملف كله)
		if(copyCodeBtn){ copyCodeBtn.addEventListener('click', async ()=>{
			const full = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;
			const ok = await copyText(full);
			const old = copyCodeBtn.textContent; copyCodeBtn.textContent = ok ? '✅ تم نسخ الكود' : '❌ فشل النسخ';
			setTimeout(()=> copyCodeBtn.textContent = old, 1800);
		}); }

		// زر: نسخ أوامر التشغيل
		if(copyCmdsBtn){ copyCmdsBtn.addEventListener('click', async ()=>{
			const host = location.hostname || 'localhost';
			const cmds = `# تشغيل خادم محلي سريع ثم فتح اللعبة\ncd /workspace\npython3 -m http.server 8000\n\n# افتح أحد الروابط التالية بعد التشغيل:\nhttp://localhost:8000/jasim-adventure/super-jasim-standalone.html\nhttp://${host}:8000/jasim-adventure/super-jasim-standalone.html\n`;
			const ok = await copyText(cmds);
			const old = copyCmdsBtn.textContent; copyCmdsBtn.textContent = ok ? '✅ تم نسخ الأوامر' : '❌ فشل النسخ';
			setTimeout(()=> copyCmdsBtn.textContent = old, 1800);
		}); }

		// زر: فتح رابط التشغيل مباشرة
		if(openServerBtn){ openServerBtn.addEventListener('click', ()=>{
			const host = location.hostname || 'localhost';
			const url = `http://${host}:8000/jasim-adventure/super-jasim-standalone.html`;
			window.open(url, '_blank');
		}); }

		// زر: فتح الكود في تبويب جديد (بديل آمن للنسخ اليدوي)
		function openCodeInTab(html){
			const blob = new Blob([html], {type:'text/html;charset=utf-8'});
			const url = URL.createObjectURL(blob);
			window.open(url, '_blank');
			setTimeout(()=> URL.revokeObjectURL(url), 30000);
		}
		if(openCodeBtn){ openCodeBtn.addEventListener('click', ()=>{
			const full = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;
			openCodeInTab(full);
		}); }

		// زر: تنزيل الملف كـ HTML
		function downloadAsFile(html){
			const blob = new Blob([html], {type:'text/html;charset=utf-8'});
			const a = document.createElement('a');
			a.href = URL.createObjectURL(blob);
			a.download = 'super-jasim-standalone.html';
			document.body.appendChild(a);
			a.click();
			setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1000);
		}
		if(downloadCodeBtn){ downloadCodeBtn.addEventListener('click', ()=>{
			const full = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;
			downloadAsFile(full);
		}); }

		function start(){ state.game='playing'; hideMsg(); }
		function togglePause(){ if(state.game==='playing'){ state.game='paused'; showMsg('متوقف مؤقتاً','اضغط P للاستمرار'); } else if(state.game==='paused'){ state.game='playing'; hideMsg(); } }
		function showMsg(t, s=''){ ui.msg.innerHTML = t + (s?('<br><small>'+s+'</small>'):''); ui.msg.style.display='flex'; }
		function hideMsg(){ ui.msg.style.display='none'; }
		showMsg('القائمة الرئيسية','اضغط Enter للبدء');

		// رسوميات مبسطة مستوحاة من ماريو
		function drawBackground(){
			// سماء
			const g1 = ctx.createLinearGradient(0,0,0,H);
			g1.addColorStop(0,'#76b8ff'); g1.addColorStop(.6,'#8cd1ff'); g1.addColorStop(1,'#63adff');
			ctx.fillStyle = g1; ctx.fillRect(cam.x, cam.y, cam.w, cam.h);
			// سحب
			ctx.fillStyle = 'rgba(255,255,255,.9)';
			for(let i=0;i<6;i++){
				const cx = (i*220 - (cam.x*0.4)%220) + 60; const cy = 80 + (i%3)*30;
				drawCloud(cx, cy);
			}
			// تلال
			for(let i=0;i<5;i++){
				const x = (i*280 - (cam.x*0.2)%280);
				drawHill(x, H-60, 120 + (i%2)*40);
			}
		}
		function drawCloud(x,y){ ctx.beginPath(); ctx.arc(x,y,18,0,Math.PI*2); ctx.arc(x+18,y+6,16,0,Math.PI*2); ctx.arc(x-16,y+8,14,0,Math.PI*2); ctx.fill(); }
		function drawHill(x, baseY, w){ ctx.fillStyle = '#4CAF50'; ctx.beginPath(); ctx.moveTo(x, baseY); ctx.quadraticCurveTo(x+w/2, baseY-50, x+w, baseY); ctx.lineTo(x+w, H); ctx.lineTo(x, H); ctx.closePath(); ctx.fill(); }

		function rect(a){ ctx.fillRect(a.x, a.y, a.w, a.h); }
		function drawPlatform(p){
			if(p.type==='ground'){ ctx.fillStyle = '#6d4c41'; rect(p); ctx.fillStyle = '#8bc34a'; ctx.fillRect(p.x, p.y-6, p.w, 6); }
			else { ctx.fillStyle = '#8bc34a'; rect(p); ctx.strokeStyle='#33691e'; ctx.lineWidth=2; ctx.strokeRect(p.x+1,p.y+1,p.w-2,p.h-2); }
		}
		function drawEnemy(e){ ctx.fillStyle = e.type==='goomba' ? '#8D6E63' : '#ef5350'; rect(e); }
		function drawCoin(c){ if(!c.a) return; ctx.save(); ctx.translate(c.x+c.w/2, c.y+c.h/2); ctx.rotate(c.r); ctx.fillStyle = '#FFD700'; ctx.fillRect(-c.w/2, -c.h/2, c.w, c.h); ctx.restore(); }
		function drawBullet(b){ ctx.fillStyle = '#FF9800'; rect(b); }
		function drawPlayer(){ ctx.fillStyle = '#1976D2'; rect(player); ctx.fillStyle='#FFC107'; ctx.fillRect(player.x+6, player.y+6, 6, 6); }

		function update(dt){
			if(state.game!=='playing') return;
			// إدخال
			const left = state.keys['ArrowLeft'] || state.keys['KeyA'] || state.touch.left;
			const right = state.keys['ArrowRight'] || state.keys['KeyD'] || state.touch.right;
			const jump = state.keys['Space'] || state.keys['ArrowUp'] || state.keys['KeyW'] || state.touch.jump;
			const fire = state.keys['ControlLeft'] || state.keys['ControlRight'] || state.touch.fire; // Ctrl لإطلاق الرصاص
			player.vx = 0;
			if(left){ player.vx = -3.2; player.face = -1; }
			if(right){ player.vx = 3.2; player.face = 1; }
			if(jump && player.on){ player.vy = -10.5; player.on = false; }
			if(fire){ shoot(); }

			// فيزياء
			player.vy += 0.55; if(player.vy>14) player.vy=14;
			player.x += player.vx; player.y += player.vy;

			// تصادم بسيط مع المنصات
			player.on = false;
			for(const p of platforms){
				if(overlap(player,p)){
					const ox = Math.min(player.x+player.w - p.x, p.x+p.w - player.x);
					const oy = Math.min(player.y+player.h - p.y, p.y+p.h - player.y);
					if(ox < oy){ // حل أفقي
						if(player.x < p.x) player.x = p.x - player.w; else player.x = p.x + p.w;
						player.vx = 0;
					}else{ // حل رأسي
						if(player.y < p.y){ player.y = p.y - player.h; player.vy = 0; player.on = true; }
						else { player.y = p.y + p.h; player.vy = 0; }
					}
				}
			}

			// الأعداء (مشي ذهاباً وإياباً + جاذبية)
			for(const e of enemies){ if(!e.alive) continue; e.vy += 0.55; if(e.vy>14) e.vy=14; e.x += e.vx; e.y += e.vy; e.on=false; for(const p of platforms){ if(overlap(e,p)){ if(e.y+e.h - p.y < 20 && e.vy>=0){ e.y = p.y - e.h; e.vy=0; e.on=true; } } } if(Math.abs(e.x - e.base) > 80) e.vx *= -1; }

			// رصاص
			for(let i=bullets.length-1;i>=0;i--){ const b=bullets[i]; b.x += b.vx; if(b.x<cam.x-100||b.x>cam.x+cam.w+100){ bullets.splice(i,1); continue; } for(const e of enemies){ if(e.alive && overlap(b,e)){ e.alive=false; bullets.splice(i,1); state.score+=100; break; } } }

			// عملات
			for(const c of coins){ c.r += 0.12; if(c.a && overlap(player,c)){ c.a=false; state.coins++; state.score+=50; } }

			// كاميرا تتبع
			cam.x = Math.max(0, player.x - W*0.45);

			// وقت
			state.time -= dt/1000; if(state.time<=0){ loseLife(); }
		}

		function render(){
			ctx.save();
			ctx.translate(-cam.x, -cam.y);
			drawBackground();
			for(const p of platforms){ if(inView(p)) drawPlatform(p); }
			for(const c of coins){ if(c.a && inView(c)) drawCoin(c); }
			for(const e of enemies){ if(e.alive && inView(e)) drawEnemy(e); }
			for(const b of bullets){ if(inView(b)) drawBullet(b); }
			drawPlayer();
			ctx.restore();
			ui.score.textContent = state.score; ui.lives.textContent = state.lives; ui.coins.textContent = state.coins; ui.level.textContent = state.level; ui.time.textContent = Math.max(0, Math.floor(state.time));
		}

		function inView(o){ return o.x+o.w>cam.x && o.x<cam.x+cam.w && o.y+o.h>cam.y && o.y<cam.y+cam.h; }
		function overlap(a,b){ return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y; }
		function shoot(){ const now=performance.now(); if(now-state.lastShot<220) return; state.lastShot=now; const b={x:player.x + (player.face===1?player.w: -6), y:player.y+player.h/2-3, w:8, h:6, vx: player.face*7.5}; bullets.push(b); }
		function loseLife(){ state.lives--; if(state.lives<=0){ state.game='over'; showMsg('انتهت اللعبة!','اضغط Enter لإعادة البدء'); } else { // إرجاع بسيط
			player.x=120; player.y=380; player.vx=player.vy=0; state.time=300; cam.x=0; }
		}

		let last = performance.now();
		function loop(){
			const now = performance.now(); const dt = now-last; last=now;
			// FPS
			state.frames++; if(now - state._lfps > 500){ state.fps = Math.round((state.frames*1000)/(now-state._lfps)); state.frames=0; state._lfps=now; ui.perf.textContent = `FPS: ${state.fps} | Objects: ${enemies.filter(e=>e.alive).length + coins.filter(c=>c.a).length + bullets.length}`; }
			update(dt); render(); requestAnimationFrame(loop);
		}
		loop();
	})();
	</script>
</body>
</html>